---
# roles/ubuntu/tasks/main.yml

- name: add PPAs
  apt_repository:
    repo: "{{ item.url }}"
    filename: "{{ item.name }}"
    state: present
    update_cache: no
  with_items:
    - "{{ repos[ansible_distribution_release] }}"
  become: true
  become_user: root

#- name: add APT key for HipChat
#  apt_key:
#    url: 'https://atlassian.artifactoryonline.com/atlassian/api/gpg/key/public'
#    state: present
#  become: true
#  become_user: root

- name: add APT key for Google Chrome
  apt_key:
    url: 'https://dl-ssl.google.com/linux/linux_signing_key.pub'
    state: present
  become: true
  become_user: root

- name: add APT key for Vivaldi
  apt_key:
    url: 'http://repo.vivaldi.com/archive/linux_signing_key.pub'
    state: present
  become: true
  become_user: root

- name: add APT key for VirtualBox 1
  apt_key:
    url: 'https://www.virtualbox.org/download/oracle_vbox_2016.asc'
    state: present
  become: true
  become_user: root

- name: add APT key for VirtualBox 2
  apt_key:
    url: 'https://www.virtualbox.org/download/oracle_vbox.asc'
    state: present
  become: true
  become_user: root

- name: add config for Oracle Java contributor agreement
  debconf:
    name: oracle-java8-installer
    question: shared/accepted-oracle-license-v1-1
    vtype: boolean
    value: true
  become: true
  become_user: root

- name: update APT cache
  apt:
    upgrade: dist
    update_cache: yes
    state: latest
  become: true
  become_user: root

- name: install packages
  apt:
    name: "{{ item }}"
    state: latest
    allow_unauthenticated: yes
  with_items:
    - "{{ packages['common'] }}"
    - "{{ packages[ansible_distribution_release] }}"
  become: true
  become_user: root

#- name: remove packages
#  apt:
#    name: "{{ item }}"
#    state: absent
#    allow_unauthenticated: yes
#  with_items:
#    - "{{ remove_packages }}"
#  become: true
#  become_user: root

#- name: Infinality
#  replace:
#    dest: /etc/profile.d/infinality-settings.sh
#    regexp: '^USE_STYLE=.*'
#    replace: 'USE_STYLE="UBUNTU"'
#  become: true
#  become_user: root

- name: make Gnome/Git keyring integration helper
  command: make --directory=/usr/share/doc/git/contrib/credential/gnome-keyring
  become: true
  become_user: root

- name: make Gnome/Git keyring integration helper
  command: git config --global credential.helper /usr/share/doc/git/contrib/credential/gnome-keyring/git-credential-gnome-keyring

- name: update GRUB to disable intel_pstate driver
  replace:
    dest: /etc/default/grub
    regexp: 'GRUB_CMDLINE_LINUX_DEFAULT="(.*)"'
    replace: 'GRUB_CMDLINE_LINUX_DEFAULT="intel_pstate=disable \1"'
  become: true
  become_user: root

- name: update grub
  command: update-grub
  become: true
  become_user: root

- name: add modules to load at boot time
  lineinfile:
    dest: /etc/modules
    line: "{{ item }}"
    state: present
  with_items:
    - "cpufreq_ondemand"
    - "cpufreq_userspace"
  become: true
  become_user: root
